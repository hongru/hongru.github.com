(function(o,n){function d(i){i=a.call(i).toLowerCase();return i.substring(8,i.length-1)}function g(i,l,m){var b=-1,f=c.call(arguments,0);i=j[e.$name]||{};l=[];for(m=true;f[++b];)if(d(f[b])==="boolean")m=f[b];else d(f[b])==="object"&&l.push(f[b]);if(l.length>=2)i=l.splice(0,1)[0];for(b=0;b<l.length;b++){f=l[b];for(var k in f)if(!i.hasOwnProperty(k)||m)i[k]=f[k]}return i}var e={$name:"Laro",$version:"0.1",$description:"game engine based on html5"},a=Object.prototype.toString,c=Array.prototype.slice,
j=this||o,h=g({},e,{toType:d,extend:g,register:function(i,l){var m=i.split("."),b=-1,f=j;if(m[0]=="")m[0]=e.$name;for(;m[++b];){if(f[m[b]]===n)f[m[b]]={};f=f[m[b]]}l&&l.call(f,j[e.$name])},randomRange:function(i,l){return i+Math.random()*(l-i)},randomBool:function(){return Math.random()>=0.5},curry:function(i,l){return function(){typeof i=="function"&&i.apply(l,arguments)}},curryWithArgs:function(i,l){var m=Array.prototype.slice.call(arguments,0);delete m[0];delete m[1];return function(){typeof i==
"function"&&i.apply(l,m.concat(arguments))}}});this[e.$name]=o[e.$name]=h})(window);
(function(o,n){var d=Object.prototype.toString,g={};g.isArray=Array.isArray||function(a){return d.call(a)==="[object Array]"};g.isString=function(a){return!!(a===""||a&&a.charCodeAt&&a.substr)};g.isObject=function(a){return a===Object(a)};var e=function(a,c,j){function h(k){var r=k;if(k&&k.substring(0,4)=="url(")r=k.substring(4,k.length-1);return!e.registered[r]&&(!e.__checkURLs||!e.__checkURLs[r])&&k&&k.length>4&&k.substring(0,4)=="url("}var i=-1,l=[];if(g.isArray(a)){i=a;for(var m=0;m<i.length;m++)if(e.registered[i[m]]||
h(i[m]))l.push(i[m]);a=l[0];i=1}else for(;typeof arguments[++i]=="string";)if(e.registered[a]||h(a))l.push(arguments[i]);c=arguments[i];j=arguments[++i];if(l.length>1){var b=c;c=function(){e(l,b,j)}}i=e.registered[a];if(!e.__checkURLs)e.__checkURLs={};if(h(a)&&a.substring(0,4)=="url("){a=a.substring(4,a.length-1);if(!e.__checkURLs[a]){l[0]=a;e.register(a,a);i=e.registered[a];m=e.prototype.getCallbackQueue(a);var f=new e.prototype.curCallBack(function(){e.__checkURLs[a]=true});m.push(f);m.push(new e.prototype.curCallBack(c,
j));j=c=n}}if(i){for(m=i.requirements.length-1;m>=0;m--)if(e.registered[i.requirements[m].name]){e(i.requirements[m].name,function(){e(a,c,j)},j);return}for(m=0;m<i.urls.length;m++)if(m==i.urls.length-1)c?e.load(i.name,i.urls[m],i.isAsyn,i.asyncWait,new e.prototype.curCallBack(c,j)):e.load(i.name,i.urls[m],i.isAsyn,i.asyncWait);else e.load(i.name,i.urls[m],i.isAsyn,i.asyncWait)}else c&&c.call(j)};e.prototype={register:function(a,c,j,h){if(g.isObject(a)){c=a;c=new e.prototype.__register(c.name,c.isAsyn,
c.asyncWait,h)}else c=new e.prototype.__register(a,c,j,h);if(!e.registered)e.registered={};e.registered[a]&&window.console&&window.console.log('Warning: Module named "'+a+'" was already registered, Overwritten!!!');return e.registered[a]=c},__register:function(a,c,j){this.name=a;var h=0,i=arguments[++h];if(i&&typeof i=="boolean"){this.isAsyn=i;i=arguments[++h]}else this.isAsyn=true;this.asyncWait=i&&typeof i=="number"?j:0;this.urls=[];if(i&&i.length&&typeof i!="string")this.urls=i;else for(h=h;h<
arguments.length;h++)arguments[h]&&typeof arguments[h]=="string"&&this.urls.push(arguments[h]);this.requirements=[];this.require=function(l){var m=[];m=Object.prototype.toString.call(l)=="[object Array]"&&l.length?l:Array.prototype.slice.call(arguments,0);for(var b=0;b<m.length;b++)this.requirements.push({name:m[b]});return this};this.register=function(l,m,b,f){return e.register(l,m,b,f)};return this},defaultAsyncTime:10,load:function(a,c,j,h,i){if(h==n)h=e.defaultAsyncTime;if(!e.loadedscripts)e.loadedscripts=
[];var l=e.prototype.getCallbackQueue(c);l.push(new e.prototype.curCallBack(function(){e.loadedscripts.push(e.registered[a]);e.registered[a]=n},null));if(i){l.push(i);if(l.length>2)return}j?e.asynLoadScript(a,c,h,l):e.xhrLoadScript(a,c,l)},xhrLoadScript:function(a,c,j){var h;if(window.XMLHttpRequest)h=new XMLHttpRequest;else if(window.ActiveXObject)h=new ActiveXObject("Microsoft.XMLHTTP");h.onreadystatechange=function(){if(h.readyState==4&&h.status==200){e.injectScript(h.responseText,a);e.loadProgressCallback&&
e.loadProgressCallback(a,c);if(j)for(var i=0;i<j.length;i++)j[i].runCallback();e.__callbackQueue[c]=n}};j.length>1?h.open("GET",c,true):h.open("GET",c,false);h.send(null)},asynLoadScript:function(a,c,j,h){var i=e.prototype.createScriptNode();i.setAttribute("src",c);if(h){var l=function(){e.__callbackQueue[c]=n;for(var m=0;m<h.length;m++)h[m].runCallback();h=[]};i.onload=i.onreadystatechange=function(){if(!i.readyState||i.readyState=="loaded"||i.readyState=="complete"||i.readyState==4&&i.status==200)j>
0?setTimeout(l,j):l()}}document.getElementsByTagName("head")[0].appendChild(i);e.loadProgressCallback&&e.loadProgressCallback(a,c)},curCallBack:function(a,c){this.callback=a;this.context=c;this.runCallback=function(){this.callback&&(this.context?this.callback.call(this.context):this.callback())}},getCallbackQueue:function(a){if(!e.__callbackQueue)e.__callbackQueue={};var c=e.__callbackQueue[a];c||(c=e.__callbackQueue[a]=[]);return c},createScriptNode:function(){var a=document.createElement("script");
a.setAttribute("type","text/javascript");a.setAttribute("language","Javascript");return a},injectScript:function(a,c){var j=e.prototype.createScriptNode();try{j.setAttribute("name",c)}catch(h){}j.text=a;document.getElementsByTagName("head")[0].appendChild(j)}};e.register=e.prototype.register;e.load=e.prototype.load;e.defaultAsyncTime=e.prototype.defaultAsyncTime;e.asynLoadScript=e.prototype.asynLoadScript;e.xhrLoadScript=e.prototype.xhrLoadScript;Laro.extend({module:e,use:e,multiModule:function(a,
c,j){var h=-1,i=0,l=[];if(g.isArray(a))l=a;else{for(;g.isString(arguments[++h]);)l.push(arguments[h]);c=arguments[h];j=arguments[++h]}h=0;for(var m=l.length;h<m;h++)e(l[h],function(){i++;i==l.length&&c&&c.call(j)})}})})(window);
Laro.register(".err",function(){function o(g){this.assign(g)}function n(g){this.assign(g)}function d(g){this.assign(g)}o.prototype=Error();o.prototype.constructor=o;o.prototype.assign=function(g){this.message=g===undefined?"":g};n.prototype=new o;n.prototype.constructor=n;d.prototype=new o;d.prototype.constructor=d;this.assert=function(g,e){if(!g)throw new n(e);};this.RuntimeException=o;this.AssertionError=n;this.Exception=d;Laro.extend(this)});
Laro.register(".base",function(){function o(i){return g.call(typeof i===c?i:function(){},i,1)}function n(i,l,m){return function(){var b=this.supr;this.supr=m[h][i];var f=l.apply(this,arguments);this.supr=b;return f}}function d(i,l,m){for(var b in l)if(l.hasOwnProperty(b))i[b]=typeof l[b]===c&&typeof m[h][b]===c&&j.test(l[b])?n(b,l[b],m):l[b]}function g(i,l){function m(){}function b(){if(this.initialize)this.initialize.apply(this,arguments);else{l||r&&f.apply(this,arguments);p.apply(this,arguments)}}
m[h]=this[h];var f=this,k=new m,r=typeof i===c,p=r?i:this,t=r?{}:i;b.methods=function(q){d(k,q,f);b[h]=k;return this};b.methods.call(b,t).prototype.constructor=b;b.extend=arguments.callee;b[h].implement=b.statics=function(q,s){q=typeof q=="string"?function(){var u={};u[q]=s;return u}():q;d(this,q,f);return this};return b}var e=this,a=e.Class,c="function",j=/xyz/.test(function(){})?/\bsupr\b/:/.*/,h="prototype";o.noConflict=function(){e.Class=a;return this};e.Class=o;Laro.Class=o});
Laro.register(".geometry",function(o){var n=o.err.assert;o=o.base.Class;var d=o({initialize:function(g,e,a,c){n(g>=0&&g<=255,"Pixel32 wrong --\> r");n(e>=0&&e<=255,"Pixel32 wrong --\> g");n(a>=0&&a<=255,"Pixel32 wrong --\> b");this.r=g;this.g=e;this.b=a;this.a=c===undefined?255:c;this.normalized=[g/255,e/255,a/255,this.a>1?this.a/255:this.a]},equal:function(g){return g instanceof d?this.r==g.r&&this.g==g.g&&this.b==g.b&&this.a==g.a:false},toString:function(){return"rgba("+this.r+", "+this.g+", "+
this.b+", "+this.normalized[3]+")"},rgbString:function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"}});this.Pixel32=d;Laro.extend(this)});
Laro.register(".game",function(o){var n=o.Pixel32||o.geometry.Pixel32,d=o.toType;o=(o.Class||o.base.Class)(function(a,c,j){if(!(a==undefined||d(a)!="object")){this.host=a;this.fsm=c;this.stateId=j;this.isSuspended=false}}).methods({enter:function(){throw"no enter";},leave:function(){throw"no leave";},update:function(){throw"no update";},suspended:function(){throw"no suspended";},message:function(){throw"no message";},suspend:function(){throw"no suspend";},resume:function(){throw"no resume";},preload:function(){throw"no preload";
},cancelPreload:function(){throw"no cancelPreload";},transition:function(){return false}});var g=o.extend(function(a,c,j,h){this.stateId=a;a=function(){};this.isSuspended=false;this.enter=c!=null?c:a;this.leave=j!=null?j:a;this.update=h!=null?h:a}),e=o.extend(function(){this.isSuspended=false;this.dimTimeLeft=0}).methods({update:function(a){this.dimTimeLeft-=a;if(this.dimTimeLeft<0)this.dimTimeLeft=0},draw:function(a){if(this.dimTimeLeft>0){var c=new n(0,0,0,Math.min(255,765*this.dimTimeLeft));a.drawQuad(null,
c)}},suspended:function(){this.dimTimeLeft=0.25},onMouse:function(){throw"no onMouse";}});this.BaseState=o;this.SimpleState=g;this.AppState=e});
Laro.register(".game",function(o){var n=o.SimpleState||o.game.SimpleState,d=(o.Class||o.base.Class)(function(g,e,a){if(g!=undefined){this.host=g;this.onStateChange=a;this.stateArray=[];for(a=0;a<e.length;a+=2){var c=e[a],j=e[a+1];this.stateArray[c]=j instanceof n?j:new j(g,this,c)}this.currentState=d.kNoState;this.numSuspended=0;this.suspendedArray=[];this.numPreloaded=0;this.preloadedArray=[];this.numStates=this.stateArray.length}}).methods({enter:function(g,e){this.setState(g,e)},leave:function(){this.setState(d.kNoState)},
update:function(g){for(var e=0;e<this.numSuspended;e++)this.stateArray[this.suspendedArray[e]].suspended(g);if(this.currentState!=d.kNoState){this.stateArray[this.currentState].update(g);this.currentState!=d.kNoState&&this.stateArray[this.currentState].transition()}},message:function(g){this.currentState!=d.kNoState&&this.stateArray[this.currentState].message(g)},messageSuspended:function(g){for(var e=0;e<this.numSuspended;e++)this.stateArray[this.suspendedArray[e]].message(g)},tryChangeState:function(g,
e,a,c,j){if(c==undefined)c=true;if(j==undefined)j=true;if(e==d.kNextState)e=this.currentState+1;if(g&&(e!=this.currentState||c)){console.log(e);this.setState(e,a,j);return true}return false},setState:function(g,e,a){if(g==d.kNextState)g=this.currentState+1;if(g==d.kNoState){for(;this.numSuspended>0;this.numSuspended--){this.stateArray[this.suspendedArray[this.numSuspended-1]].leave();this.stateArray[this.suspendedArray[this.numSuspended-1]].isSuspended=false}for(;this.numPreloaded>0;this.numPreloaded--)this.stateArray[this.preloadedArray[this.numPreloaded-
1]].cancelPreload()}else if(a){this.stateArray[this.currentState].suspended();this.stateArray[this.currentState].isSuspended=true;this.suspendedArray[this.numSuspended++]=this.currentState}else{this.currentState!=d.kNoState&&this.stateArray[this.currentState].leave();if(!this.stateArray[g].isSuspended)for(;this.numSuspended>0;this.numSuspended--){this.stateArray[this.suspendedArray[this.numSuspended-1]].leave();this.stateArray[this.suspendedArray[this.numSuspended-1]].isSuspended=false}}for(a=0;a<
this.numPreloaded;a++)this.preloadedArray[a]!=g&&this.stateArray[this.preloadedArray[a]].cancelPreload();this.numPreloaded=0;this.onStateChange!=undefined&&this.onStateChange(this.currentState,g,e);a=this.currentState;this.currentState=g;if(this.currentState!=d.kNoState)if(this.stateArray[this.currentState].isSuspended){this.stateArray[this.currentState].resume(e,a);this.stateArray[this.currentState].isSuspended=false;--this.numSuspended}else this.stateArray[this.currentState].enter(e,a)},getCurrentState:function(){if(this.currentState==
d.kNoState)return null;return this.stateArray[this.currentState]},preload:function(g){this.preloadedArray[this.numPreloaded++]=g},isSuspended:function(g){return this.stateArray[g].isSuspended}}).statics({kNoState:-1,kNextState:-2});o=d.extend().methods({draw:function(g){for(var e=0;e<this.numSuspended;e++)this.stateArray[this.suspendedArray[e]].draw(g);(e=this.getCurrentState())&&e.draw(g)},onMouse:function(g,e,a,c){var j=this.getCurrentState();j&&j.onMouse(g,e,a,c)}});this.FSM=d;this.AppFSM=o;Laro.extend(this)});
Laro.register(".game",function(o){var n=o.base.Class||o.Class;window.requestAnimFrame=this.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(g){window.setTimeout(g,1E3/60)}}();var d=n(function(g,e){function a(){if(c){requestAnimFrame(a);var h=new Date,i=(h-j)/1E3;if(i>=3)i=0.25;g.call(e,i);j=h}}var c=true,j=new Date;this.stop=function(){c=false};
this.resume=function(){c=true;j=new Date;a()};a();return this});n=n(function(g,e,a){this.maxTime=a;this.from=g;this.to=e;this.time=0;this.isDone=false}).methods({update:function(g){this.time=Math.min(this.time+g,this.maxTime)},draw:function(g){this.isDone=this.time==this.maxTime;var e=new o.Pixel32(o.lerp(this.from.r,this.to.r,this.time/this.maxTime),o.lerp(this.from.g,this.to.g,this.time/this.maxTime),o.lerp(this.from.b,this.to.b,this.time/this.maxTime),o.lerp(this.from.a,this.to.a,this.time/this.maxTime));
e.a>0&&g.drawFillScreen(e)},reset:function(){this.time=0;this.isDone=false}});this.Loop=d;this.ScreenTransitionFade=n;Laro.extend(this)});
Laro.register(".game",function(o){var n=o.Class(function(d,g){this.url=d;this.loaded=false;this.callback=g;this.channels={};this.currentChannel=null;this.genAudio();if(this.can=this.canPlayThisType()){this.bind();this.audio.load()}else this.callback&&this.callback()}).methods({genAudio:function(){this.audio=new Audio;this.audio.src=this.url;this.audio.preload="auto";if(this.audio.play&&navigator.userAgent.toLowerCase().indexOf("msie")<0){this.audio.play();this.audio.pause()}},canPlayThisType:function(d){var g=
{mp3:"audio/mpeg;",m4a:"audio/aac",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav"};if(d==undefined)d=this.url.substr(this.url.lastIndexOf(".")).replace(/\./g,"");return!!(this.audio&&this.audio.canPlayType&&this.audio.canPlayType(g[d]).replace(/no/,""))},bind:function(){var d=this;this.audio.addEventListener("loadedmetadata",function(){d.addChannel("default",0,d.getDuration())},false);this.audio.addEventListener("playing",function(){},false);this.audio.addEventListener("timeupdate",function(){},
false);this.audio.addEventListener("canplaythrough",function(){d.loaded=true;!d.channels["default"]&&d.addChannel("default",0,d.getDuration());d.callback&&d.callback()},false)},update:function(){},getVolume:function(){return this.audio.volume},setVolume:function(d){d=Math.max(0,Math.min(d,100));this.audio.volume=d},haveData:function(){var d=this.audio.readyState;if(d==1||!d)return false;else if(d==2||d==3||d==4||d==5)return true},isPlayingChannel:function(d){return!this.audio.paused&&d===this.currentChannel.name},
getDuration:function(){return this.audio.duration},getCurrentChannel:function(){return this.currentChannel},addChannel:function(d,g,e){if(o.toType(d)=="object"){d=d.name;g=d.start;e=d.duration}var a=this.getDuration();if(g>a)throw"Sound channel start wrong!";if(g+e>a)e=a-g;this.channels[d]={start:g,end:g+e,duration:e};return this.channels[d]},removeChannel:function(d){delete this.channels[d]},pause:function(){return this.audio.pause()},preloadChannel:function(d){this.pause();if(d=this.channels[d])this.audio.currentTime=
d.start},play:function(d,g){if(this.can){var e=this,a=-1;if(d==undefined)d="default";if(g==undefined)g=false;this.currentChannel&&clearTimeout(this.currentChannel.timer);if(this.haveData()){var c=this.channels[d];clearTimeout(c.timer);this.audio.currentTime=c.start;this.audio.play();if(g)a=setTimeout(function(){e.play(d,g)},c.duration*1E3);this.currentChannel={name:d,start:c.start,duration:c.duration,end:c.end,isLoop:g,startTime:+new Date,timer:a}}}}}).statics({CAN_PLAY_TYPES:function(){var d=document.createElement("audio"),
g={};if(typeof d.canPlayType==="function"){g._supported=Boolean(true);g.mp3=d.canPlayType("audio/mpeg");g.wav=d.canPlayType('audio/wav; codecs="1"');g.ogg=d.canPlayType('audio/ogg; codecs="vorbis"');g.m4a=d.canPlayType("audio/x-m4a")||d.canPlayType("audio/aac");g.webm=d.canPlayType('audio/webm; codecs="vorbis"')}else g._supported=Boolean(0);return g}()});this.Sound=n;o.extend({Sound:n})});
Laro.register(".game",function(o){var n=o.base.Class,d=o.toType,g=o.geometry.Pixel32,e=n(function(h){this.name=h.name;this.filename=h.filename;this.sources={};for(var i in h.sources)if(h.sources.hasOwnProperty(i)){var l=h.sources[i];this.sources[l.name]=l.data}}),a=function(h){var i=h.lastIndexOf(".");i=h.substr(i);if(/png|jpg|jpeg|gif|bmp/.test(i))return"image";else if(/ogg|mp3|m4a|wav/.test(i))return"sound"},c=n(function(h){this.basePath=this.imagePath=h||"resources/";this.loadedImages={};this.loadedSounds=
{}}).methods({loadImage:function(h){var i=this.loadedImages[h];if(i)return i;i=new Image;i.src=this.imagePath+h;return this.loadedImages[h]=i},preloadImages:function(h,i){var l=0,m=[],b=-1,f=arguments;if(d(h)=="array")m=h;else{for(;d(f[++b])=="string";)m.push(f[b]);i=f[b]}var k=m.length;b=function(){l++;i&&i(l/k)};f=function(){console.log("an image load error")};for(var r=0;r<k;r++){var p=m[r],t=this.loadedImages[p];if(t!=undefined)l++;else{t=new Image;t.src=this.imagePath+p;t.onload=b;t.onerror=
f;this.loadedImages[p]=t}}i&&i(l/k)},preload:function(h,i){var l=0,m=[],b=-1,f=arguments;if(d(h)=="array")m=h;else{for(;d(f[++b])=="string";)m.push(f[b]);i=f[b]}var k=m.length;b=function(){l++;i&&i(l/k)};for(f=0;f<k;f++){var r=m[f];if(a(r)=="image"){var p=this.loadedImages[r];if(p)l++;else{p=new Image;p.src=this.basePath+r;p.onload=b;p.onerror=b;this.loadedImages[r]=p}}else if(a(r)=="sound")if(p=this.loadedSounds[r])l++;else{p=new o.Sound(this.basePath+r,b);this.loadedSounds[r]=p}}i&&i(l/k)}}).statics({getInstance:function(){if(c.instance===
null)c.instance=new c(this.imagePath);return c.instance},instance:null}),j=n(function(h,i,l,m){m=m==undefined?null:m;this.image=h;this.shapes=i;this.index=l;this.name=m});n=n(function(h){this.baseColor=new g(h.base_r,h.base_g,h.base_b);this.outlineColor=new g(h.outline_r,h.outline_g,h.outline_b);this.size=h.size;this.font=h.font;this.outline=h.outline}).methods({getFont:function(){var h=[];h.push("normal");h.push(this.size+"px");h.push(this.font);return h.join(" ")},generateCanvas:function(h,i){var l=
document.createElement("canvas"),m=l.getContext("2d");m.font=this.getFont();var b=this.outline*2;if(i!=undefined){h=this.wrapText(m,h,i);l.width=m.measureText(h).width+8+b*2;l.height=(this.size+b*4)*h.split("\n").length}else{l.width=m.measureText(h).width+8+b*2;l.height=this.size+b*4}m.fillStyle=this.baseColor.toString();m.textBaseline="middle";m.textAlign="left";m.font=this.getFont();if(b!=0){m.strokeStyle=this.outlineColor.toString();m.lineWidth=b;m.strokeText(h,b,this.size/2+b*2)}m.fillText(h,
b,this.size/2+b*2);return l},wrapText:function(h,i,l){var m="";i=i.split(" ");for(var b=0;b<i.length;){m+=h.measureText(m+i[b]).width>=l?"\n"+i[b]:b!=0?" "+i[b]:i[b];b++}return m}});this.Atlas=e;this.ResourceLoader=c;this.Tile=j;this.Font=n;Laro.extend(this)});
Laro.register(".action",function(o){var n=o.extend;this.Animation=(o.Class||o.base.Class)(function(d,g){n(this,d);this.frames=g;if(d.framerate==undefined)d.framerate=20;this.animationLength=g.length/d.framerate}).methods({getEvents:function(d,g){for(var e=[],a=0;a<this.events.length;a++){var c=this.events[a];c.time>=d&&c.time<g&&e.push(c.name)}return e},getTimeForNextEvent:function(d,g){for(var e=-1,a=0;a<this.events.length;a++){var c=this.events[a];if(c.time>d&&c.time<g){if(e!=-1)break;e=c.time}}return e},
getEventsSlow:function(d,g,e,a){var c=[],j,h;for(j=0;j<this.events.length;j++){h=this.events[j];h.time>=d&&h.time<a&&c.push(h.name)}for(j=0;j<this.events.length;j++){h=this.events[j];h.time>=e&&h.time<g&&c.push(h.name)}return c}});Laro.extend(this)});
Laro.register(".action",function(o){var n=(o.Class||o.base.Class)(function(d,g,e){if(d instanceof n)d=d.animation;if(e==undefined)e=false;this.animation=d;this.callback=g==undefined?null:g;this.time=this.currentFrame=0;this.renderMirrored=e;this.speed=1;this.start=0;this.end=1;this.playTo=-1;this.loop=true;this.playing=false}).methods({clone:function(){var d=new n(this.animation,this.callback,this.renderMirrored);d.start=this.start;d.end=this.end;d.time=this.time;return d},update:function(d){if(this.playing){var g=
this.time;this.time+=this.speed*d;var e=0.5/this.animation.framerate,a=this.animation.animationLength;if(this.loop)this.time=this.speed>0?this.time>=a*this.end?this.start*a:this.time:this.time<=a*this.start?this.end*a-e:this.time;else{var c;if(this.speed>0){c=this.playTo>=0?this.playTo:this.end;if(this.time>=a*c){this.time=a*c-e;this.playing=false}}else{c=this.playTo>=0?this.playTo:this.start;if(this.time<=a*c){this.time=a*c+e;this.playing=false}}}this.time=Math.max(this.time,0);this.currentFrame=
Math.floor(this.time*this.animation.framerate)%this.animation.nbrOfFrames;if(this.callback!=null){e=this.playing?this.time:this.speed>0?a*this.end:this.animation.animationLength*this.start;d=g<e?this.animation.getEvents(g,e):this.animation.getEventsSlow(g,e,a*this.start,a*this.end,d);if(d.length>=2){this.time=this.animation.getTimeForNextEvent(g,e);d=[d[0]]}for(g=0;g<d.length;g++)this.callback(d[g],this);this.playing||this.callback("stopped",this)}}else this.currentFrame=Math.floor(this.time*this.animation.framerate)%
this.animation.nbrOfFrames},draw:function(d,g,e,a,c,j){var h=this.animation.frames[this.currentFrame];d.drawImage(h,this.renderMirrored?g-(h.textureWidth-this.animation.pivotx):g-this.animation.pivotx,e-this.animation.pivoty,a,false,c,j,this.renderMirrored)},mirror:function(){this.renderMirrored=!this.renderMirrored},play:function(d){this.playTo=-1;if(d==undefined)d=true;if(this.time>=this.end*this.animation.animationLength-0.5/this.animation.framerate)this.time=this.start*this.animation.animationLength;
this.loop=d;this.playing=true},playToTime:function(d){this.playTo=d;if(this.time>=this.playTo*this.animation.animationLength-0.5/this.animation.framerate)this.time=this.start*this.animation.animationLength;this.playing=true},playToEvent:function(d){for(var g=0;g<this.animation.events.length;g++){var e=this.animation.events[g];if(e.name==d){this.playToTime(e.time/this.animation.animationLength);break}}},stop:function(){this.playing=false},rewind:function(){this.time=this.start*this.animation.animationLength},
gotoTime:function(d){this.time=d*this.animation.animationLength},gotoEvent:function(d){for(var g=0;g<this.animation.events.length;g++){var e=this.animation.events[g];if(e.name==d){this.time=e.time;break}}},gotoEnd:function(){this.time=(this.end-0.5/this.animation.framerate)*this.animation.animationLength},setRange:function(d,g){this.start=d;this.end=g;var e=this.animation.animationLength;if(this.time<d*e)this.time=d*e;if(this.time>g*e)this.time=g*e},setSpeed:function(d){this.speed=d},getLength:function(){return this.animation.animationLength*
(this.end-this.start)},getCurrentPosition:function(){return this.time},isStopped:function(){return!this.playing},setCallback:function(d){this.callback=d}});this.AnimationHandle=n;Laro.extend(this)});
Laro.register(".texture",function(o){var n=o.err.assert;this.EMBImage=this.ImageRegion=o=(o.base.Class||la.Class)(function(d,g,e,a,c,j,h,i,l){n(d instanceof HTMLImageElement||d instanceof HTMLCanvasElement,"invalid image");this.image=d;this.x=g;this.y=e;this.width=a;this.height=c;this.offsetX=j==null?0:j;this.offsetY=h==null?0:h;this.textureWidth=i==null?a:i;this.textureHeight=l==null?c:l;this.hasPadding=j>0||h>0||i>a||l>c}).methods({getImageWidth:function(){return this.image.width},getImageHeight:function(){return this.image.height}});
Laro.extend(this)});
Laro.register(".geometry",function(o){o=o.base.Class;var n=o({initialize:function(d,g){this.x=d;this.y=g},magnitudeSquared:function(){return this.x*this.x+this.y*this.y},magnitude:function(){return Math.sqrt(this.magnitudeSquared())},add:function(d){this.x+=d.x;this.y+=d.y;return this},addNew:function(d){return new n(this.x+d.x,this.y+d.y)},sub:function(d){this.x-=d.x;this.y-=d.y;return this},subNew:function(d){return new n(this.x-d.x,this.y-d.y)},mul:function(d){this.x*=d;this.y*=d;return this},
mulNew:function(d){return new n(this.x*d,this.y*d)},div:function(d){this.x/=d;this.y/=d;return this},divNew:function(d){return new n(this.x/d,this.y/d)},equal:function(d){return this.x===d.x&&this.y===d.y},notEqual:function(d){return this.x!==d.x||this.y!==d.y},copy:function(){return new n(this.x,this.y)}});this.Point2=n;Laro.extend(this)});
Laro.register(".geometry",function(o){var n=o.geometry.Point2.extend({dot:function(d){return this.x*d.x+this.y*d.y},cross:function(d){return this.x*d.x-this.y*d.y},length:function(){return this.magnitude()},normalize:function(){var d=1/this.length();this.x*=d;this.y*=d;return this},copy:function(){return new n(this.x,this.y)}});n.zero=new n(0,0);n.X=new n(1,0);n.Y=new n(0,1);this.Vector2=n;Laro.extend(this)});
Laro.register(".geometry",function(o){this.Circle=function(a,c){this.c=a;this.r=c};o.Circle=this.Circle;var n=o.geometry.Vector2,d=o.geometry.Point2,g=o.geometry.Circle||this.Circle,e=(o.base.Class||o.Class)(function(a,c,j,h){this.x0=a;this.x1=j;this.y0=c;this.y1=h;this.width=j-a+1;this.height=h-c+1}).methods({center:function(){return new n((this.x0+this.x1+1)/2,(this.y0+this.y1+1)/2)},invertBy:function(a){a=a||"x";if(a=="x")return new e(-this.x1,this.y0,-this.x0,this.y1);else if(a=="y")return new e(this.x0,
-this.y1,this.x1,-this.y0)},offset:function(a,c){if(a instanceof n||a instanceof d){a=a.x;c=a.y}return new e(this.x0+a,this.y0+c,this.x1+a,this.y1+c)},expand:function(a,c){if(a instanceof n||a instanceof d){a=a.x;c=a.y}return new e(this.x0-a,this.y0-c,this.x1+a,this.y1+c)},contains:function(a,c){return a instanceof n||a instanceof d?this.x0<=a.x&&this.y0<=a.y&&this.x1>=a.x&&this.y1>=a.y:a instanceof e?this.x0<=a.x0&&this.y0<=a.y0&&this.x1>=a.x1&&this.y1>=a.y1:this.x0<=a&&this.y0<=c&&this.x1>=a&&this.y1>=
c},overlaps:function(a,c,j){var h;if(c==undefined&&j==undefined)j=c=0;else if(c instanceof n||c instanceof d){c=c.x;j=c.y}if(a instanceof g){h=a.r;c=a.c.x+c;a=a.c.y+j;return this.x0-h<=c&&this.y0-h<=a&&this.x1+h>=c&&this.y1+h>=a}else if(a instanceof e)return!(this.x0>a.x1+c||this.x1<a.x0+c||this.y0>a.y1+j||this.y1<a.y0+j)},clip:function(a){return new n(Math.max(this.x0,Math.min(this.x1,a.x)),Math.max(this.y0,Math.min(this.y1,a.y)))},copy:function(){return new e(this.x0,this.y0,this.x1,this.y1)},include:function(a,
c){if(a instanceof n||a instanceof d){a=a.x;c=a.y}this.x0=Math.min(this.x0,a);this.y0=Math.min(this.y0,c);this.x1=Math.max(this.x1,a);this.y1=Math.max(this.y1,c);this.width=this.x1-this.x0+1;this.height=this.y1-this.y0+1}});this.Rectangle=this.Rectf=e;Laro.extend(this)});
Laro.register(".world",function(o){var n=o.err.assert,d=o.geometry.Rectf;o=(o.base.Class||Laro.Class)(function(a){if(a!=undefined){this.tiles=a;this.image=this.tiles[0].image;n(this.count>0,"arguments of Layer is not enough")}}).methods({count:function(){return this.tiles.length/5},offset:function(a){return a*5}});var g=o.extend(function(a,c,j,h){n(c.length==j*h);this.indices=c;this.sx=j;this.sy=h}).methods({index:function(a,c){return this.indices[a+this.sx*c]},tile:function(a,c){var j=c==null?a:
this.index(a,c);return j==-1?-1:j*5},previous:function(a,c){return a===0?c==0?-1:this.index(this.sx-1,c-1):this.index(a-1,c)}}),e=o.extend(function(a,c,j){n(j instanceof d);this.rectangles=c;this.rect=j});this.Layer=o;this.TileLayer=g;this.SpriteLayer=e;Laro.extend(this)});
Laro.register(".world",function(o){var n=o.geometry.Pixel32,d=o.geometry.Rectf,g=o.err.assert,e=o.world.Layer,a=o.world.SpriteLayer;this.Render=(o.base.Class||o.Class)(function(){this.scaleFactor=1;this.height=this.width=0;this.clips=[];this.defaultClip=null;this.frontToBack=false;this.calls=0;this.maxCalls=1E4;this.red=new n(255,0,0);this.green=new n(0,255,0);this.blue=new n(0,0,255);this.black=new n(0,0,0);this.white=new n(255,255,255);this.transparent=new n(0,0,0,0)}).methods({isFrontToBack:function(){return this.frontToBack},
clear:function(){},getWidth:function(){return this.width},getHeight:function(){return this.height},getSafeRect:function(){return new d(0,0,this.getWidth(),this.getHeight())},reset:function(c,j){g(c>0&&j>0,"invalid arguments");this.width=c;this.height=j;this.defaultClip=new d(0,0,c/this.scaleFactor,j/this.scaleFactor)},setScaleFactor:function(c){g(c>0,"factor wrong");this.scaleFactor=c;this.defaultClip=new d(0,0,this.getWidth()/this.scaleFactor,this.getHeight()/this.scaleFactor)},drawLine:function(){},
drawCircle:function(){},drawRect:function(){},drawQuad:function(){},drawTris:function(){},drawFilledRect:function(){},drawFilledTris:function(){},drawImage:function(){},drawTriangleImage:function(){},drawParticle:function(){},drawTilingImage:function(c,j,h,i,l,m){var b,f,k=c.textureWidth,r=c.textureHeight;for(b=0;b<i;b++)for(f=0;f<l;f++)this.drawImage(c,j+b*k,h+f*r,0,true,m)},drawLayer:function(c,j,h,i,l,m,b){var f,k,r,p,t,q,s;if(c instanceof e)for(k=l;k<l+b;k++){f=c.previous(i,k);var u=c.index(i+
m-1,k),v;f=f+1;for(s=f*5;f<=u;f++){v=c.tiles[s++];r=c.tiles[s++];p=c.tiles[s++];t=c.tiles[s++];q=e.tiles[s++];this.drawImage(v,j+r,h+p,0,t,1,null,q)}}else if(c instanceof a){k=this.isFrontToBack();for(f=0;f<c.count();f++){s=4*(k?this.count()-1-f:f);r=c.rectangles[s++];p=c.rectangles[s++];t=c.rectangles[s++];s=c.rectangles[s++];if(t>=i&&r<=i+m&&s>=l&&p<=l+b){s=5*(k?c.count()-1-f:f);v=c.tiles[s++];r=c.tiles[s++];p=c.tiles[s++];t=c.tiles[s++];q=c.tiles[s++];this.drawImage(v,j+r,h+p,0,t,1,null,q)}}}else g(false)},
drawText:function(){},drawCanvas:function(){},drawSystemText:function(){},drawFillScreen:function(){},pushClipRect:function(c){g(c instanceof d);this.clips.push(c)},popClipRect:function(){g(this.clips.length>0,"no clip to pop");return this.clips.pop()},getClipRect:function(){return this.clips.length==0?this.defaultClip:this.clips[this.clips.length-1]},flush:function(){this.calls=0}});Laro.extend(this)});
Laro.register(".world",function(o){var n=o.err.assert,d=o.toType,g=o.world.TileLayer,e=o.world.SpriteLayer;this.CanvasRender=o.world.Render.extend(function(a,c,j){this.canvas=a;this.context=this.canvas.getContext("2d");this.scaleFactor=d(c)=="number"?c:1;this.context.scale(this.scaleFactor,this.scaleFactor);if(this.frontToBack=j==undefined?false:j)this.context.globalCompositeOperation="destination-over";this.secondCanvas=document.createElement("canvas");this.secondContext=this.secondCanvas.getContext("2d")}).methods({getWidth:function(){return this.canvas.width||
800},getHeight:function(){return this.canvas.height||600},drawRect:function(a,c,j,h,i){a=Math.floor(a);c=Math.floor(c);j=Math.floor(j);h=Math.floor(h);this.context.lineWidth=2;this.context.strokeStyle=i.toString();this.context.strokeRect(a,c,j-a,h-c)},drawLine:function(a,c,j,h,i){a=Math.floor(a);c=Math.floor(c);j=Math.floor(j);h=Math.floor(h);this.context.lineWidth=2;this.context.strokeStyle=i.toString();this.context.beginPath();this.context.moveTo(a,c);this.context.lineTo(j,h);this.context.stroke()},
drawCircle:function(a,c,j,h){this.context.lineWidth=2;this.context.strokeStyle=h.toString();this.context.beginPath();this.context.arc(a,c,j,0,Math.PI*2,true);this.context.stroke()},drawFilledRect:function(a,c,j,h,i,l){if(!(this.calls++>this.maxCalls)){this.context.save();if(l!=undefined){var m=this.context.createLinearGradient(0,c,0,h);m.addColorStop(0,i.toString());m.addColorStop(0,l.toString());this.context.fillStyle=m}else this.context.fillStyle=i.toString();this.context.fillRect(a,c,j-a,h-c);
this.context.restore()}},drawImage:function(a,c,j,h,i,l,m,b){if(!(this.calls++>this.maxCalls)){this.context.save();if(d(l)=="number"&&l!=1)this.context.globalAlpha=l;this.context.translate(c,j);l=Math.floor(a.textureWidth/2);var f=Math.floor(a.textureHeight/2);if(d(h)=="number"&&h!=0){i||this.context.translate(l,f);this.context.rotate(h);this.context.translate(-l,-f)}else if(i){this.context.translate(-l,-f);c=-l;j=-f}if(b){c=-c;this.context.scale(-1,1);this.context.translate(-a.textureWidth,0);c-=
a.textureWidth}this.context.translate(a.offsetX,a.offsetY);c+=a.offsetX;j+=a.offsetY;this.frontToBack||this.drawEMBImage(a,c,j,h!==0,this.context);if(m&&m.a!=0){this.secondContext.clearRect(0,0,this.secondCanvas.width,this.secondCanvas.height);if(this.secondCanvas.width!=a.width)this.secondCanvas.width=a.width;if(this.secondCanvas.height!=a.height)this.secondCanvas.height=a.height;this.secondContext.save();this.drawEMBImage(a,0,0,false,this.secondContext);this.secondContext.globalCompositeOperation=
"source-in";this.secondContext.globalAlpha=m.a>1?m.a/255:m.a;this.secondContext.fillStyle=m.rgbString();this.secondContext.fillRect(0,0,this.secondCanvas.width,this.secondCanvas.height);this.secondContext.restore();this.context.drawImage(this.secondCanvas,0,0)}this.frontToBack&&this.drawEMBImage(a,c,j,h!=0,this.context);this.context.restore()}},scale:function(a){return Math.ceil(a*this.scaleFactor)/this.scaleFactor},drawEMBImage:function(a,c,j,h,i){if(a.image.complete)if(this.scaleFactor!==1&&!h){h=
this.scale(c);var l=this.scale(j),m=this.scale(c+a.width-h),b=this.scale(j+a.height-l);i.drawImage(a.image,a.x,a.y,a.width,a.height,h-c,l-j,m,b)}else i.drawImage(a.image,a.x,a.y,a.width,a.height,0,0,a.width,a.height)},drawText:function(a,c,j,h,i){if(!(this.calls++>this.maxCalls&&!i)){this.context.save();if(d(h)=="number")this.context.globalAlpha=h;this.context.drawImage(a,c,j);this.context.restore()}},clear:function(a){this.calls=0;this.context.clearRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/
this.scaleFactor);a&&this.drawFilledRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/this.scaleFactor,a.toString())},drawTilingImage:function(a,c,j,h,i,l){l=l==undefined?1:l;this.context.save();if(l!=1)this.globalAlpha=l;for(l=0;l<h;l++)for(var m=0;m<i;m++){this.context.save();var b=c+a.textureWidth*l-a.textureWidth/2,f=j+a.textureHeight*m-a.textureHeight/2;this.context.translate(b,f);this.drawEMBImage(a,b,f,false,this.context);this.context.restore()}this.context.restore()},drawQuad:function(a,
c){for(var j=a.length-2,h=0;h<a.length;h+=2){this.drawLine(a[h],a[h+1],a[j],a[j+1],c);j=h}},drawPoly:function(a,c){this.drawQuad(a,c)},drawTris:function(a,c){n(a.length%6!==0,"invalid points number");for(var j=a.length/6,h,i=0;i<j;i+=6){h=i+4;for(var l=i;l<i+6;l+=2){this.drawLine(a[l],a[l+1],a[h],a[h+1],c);h=l}}},drawFillScreen:function(a){if(!(this.calls++>this.maxCalls)){this.context.fillStyle=a.toString();this.context.fillRect(0,0,this.canvas.width/this.scaleFactor,this.canvas.height/this.scaleFactor)}},
drawSystemText:function(a,c,j,h){if(h instanceof o.Font){this.context.font=h.getFont();this.context.fillStyle=h.baseColor.toString();this.context.textBaseline="middle";this.context.textAlign="left";var i=h.outline*2;if(i!=0){this.context.strokeStyle=h.outlineColor.toString();this.context.lineWidth=i;this.context.strokeText(a,c,j)}}else{this.context.textBaseline="middle";this.context.textAlign="left";this.context.fillStyle=h.toString()}this.context.fillText(a,c,j)},setScaleFactor:function(a,c){c&&
this.context.scale(1/this.scaleFactor,1/this.scaleFactor);this.scaleFactor=a;this.context.scale(this.scaleFactor,this.scaleFactor);if(this.frontToBack)this.context.globalCompositeOperation="destination-over"},getContext:function(){return this.context},drawTriangleImage:function(a,c,j){var h=c[0],i=c[1],l=c[2],m=c[3],b=c[4];c=c[5];var f=j[0],k=j[1],r=j[2],p=j[3],t=j[4];j=j[5];this.context.save();this.context.beginPath();this.context.moveTo(h,i);this.context.lineTo(l,m);this.context.lineTo(b,c);this.context.closePath();
this.context.clip();var q=f*(j-p)-r*j+t*p+(r-t)*k;if(q!==0){this.context.transform(-(k*(b-l)-p*b+j*l+(p-j)*h)/q,(p*c+k*(m-c)-j*m+(j-p)*i)/q,(f*(b-l)-r*b+t*l+(r-t)*h)/q,-(r*c+f*(m-c)-t*m+(t-r)*i)/q,(f*(j*l-p*b)+k*(r*b-t*l)+(t*p-r*j)*h)/q,(f*(j*m-p*c)+k*(r*c-t*m)+(t*p-r*j)*i)/q);this.drawEMBImage(a,0,0,false,this.context);this.context.restore()}},drawParticle:function(a,c,j,h,i,l,m,b,f){if(!(this.calls++>this.maxCalls)){this.context.save();this.context.translate(c,j);if(i!=1||l!=1)this.context.scale(i,
l);if(f)this.context.globalCompositeOperation="lighter";this.drawImage(a,0,0,h,true,m,null,false);this.context.restore()}},drawCanvas:function(a,c,j){this.calls++>this.maxCalls||this.drawImage(a,c,j)},drawLayer:function(a,c,j,h,i,l,m){var b,f,k;if(a instanceof g)for(f=i;f<i+m;f++){b=a.previous(h,f);var r=a.index(h+l-1,f),p,t,q,s;b=b+1;for(k=b*5;b<=r;b++)if(!(this.calls++>this.maxCalls)){p=a.tiles[k++];t=a.tiles[k++];q=a.tiles[k++];k++;s=a.tiles[k++];t=c+t+p.offsetX;q=j+q+p.offsetY;var u=p.width,v=
p.height;if(this.scaleFactor!=1){t=this.scale(t);q=this.scale(q);u=this.scale(u);v=this.scale(v)}if(s){this.context.scale(-1,1);this.context.drawImage(p.image,p.x,p.y,p.width,p.height,-(t+u),q,u,v);this.context.scale(-1,1)}else this.context.drawImage(p.image,p.x,p.y,p.width,p.height,t,q,u,v)}}else if(a instanceof e){f=a.count;for(b=0;b<f;b++){k=4*b;p=a.rectangles[k++];s=a.rectangles[k++];r=a.rectangles[k++];k=a.rectangles[k++];if(r>=h&&p<=h+l&&k>=i&&s<=i+m)if(!(this.calls++>this.maxCalls)){k=5*b;
p=a.tiles[k++];t=a.tiles[k++];q=a.tiles[k++];r=a.tiles[k++];s=a.tiles[k++];this.drawImage(p,c+t,j+q,0,r,1,null,s)}}}else n(false)},pushClipRect:function(a){this.context.save();this.context.beginPath();this.context.moveTo(a.x0,a.y0);this.context.lineTo(a.x0,a.y1);this.context.lineTo(a.x1,a.y1);this.context.lineTo(a.x1,a.y0);this.context.lineTo(a.x0,a.y0);this.context.clip()},popClipRect:function(){this.context.restore()}});Laro.extend(this)});
Laro.register(".geometry.chaikin",function(o){var n=o.geometry.Point2;this.subDivide=function(d,g){if(d.length){do{var e=d.length;d.push(new n(d[0].x,d[0].y));for(var a=0;a<e-1;++a){var c=d[a],j=d[a+1],h=new n(0.75*c.x+0.25*j.x,0.75*c.y+0.25*j.y);c=new n(0.25*c.x+0.75*j.x,0.25*c.y+0.75*j.y);d.push(h);d.push(c)}d.push(new n(d[e-1].x,d[e-1].y));for(a=0;a<e;++a)d.shift()}while(--g>0)}};this.getLength=function(d){for(var g=0,e=null,a=1;a<d.length;a++){e=d[a].subNew(d[a-1]);g+=Math.sqrt(e.x*e.x+e.y*e.y)}return g};
this.getPointAtLength=function(d,g){if(d.length===0)return new n(0,0);if(d.length===1)return d[0];for(var e=null,a=0;a!==d.length-1;a++){e=d[a+1].subNew(d[a]);var c=Math.sqrt(e.x*e.x+e.y*e.y);if(c>g)return new n(d[a].x+e.x*g/c,d[a].y+e.y*g/c);else g-=c}return d[d.length-1]};this.getDirAtParam=function(d,g){if(d.length<2)return new n(0,0);var e=this.getLength(d);e=g*e;for(var a=null,c=0;c!==d.length-1;c++){a=d[c+1].subNew(d[c]);var j=Math.sqrt(a.x*a.x+a.y*a.y);if(j>e)return a;else e-=j}return d[d.length-
1].subNew(d[d.length-2])};this.getEvenlySpacedPoints=function(d,g,e){d=d.slice(0);var a=[],c=null;this.subdivide(d,3);var j=this.getLength(d),h=j/(g-1);a.push(d[0]);if(e){c=this.getDirAtParam(d,0);e.push(new n(-c.y,c.x))}for(var i=1;i<g-1;i++){a.push(this.getPointAtLength(d,i*h));if(e){c=this.getDirAtParam(d,i*h/j);e.push(new n(-c.y,c.x))}}a.push(d[d.length-1]);if(e){c=this.getDirAtParam(d,1);e.push(new n(-c.y,c.x))}return a};Laro.extend(this)});
Laro.register("perlin",function(o){this.start=true;this.g1=[];this.p=[];this.noise=function(n){if(this.start){this.start=false;this.init()}var d=this.setup(n,void 0,void 0,void 0,void 0);n=this.s_curve(d.rx0);return o.geometry.util.lerp(d.rx0*this.g1[this.p[d.bx0]],d.rx1*this.g1[this.p[d.bx1]],n)};this.s_curve=function(n){return n*n*(3-2*n)};this.setup=function(n){var d={};d.t=n+4096;d.bx0=Math.floor(d.t)&255;d.bx1=d.bx0+1&255;d.rx0=d.t-Math.floor(d.t);d.rx1=d.rx0-1;return d};this.init=function(){var n,
d,g;for(n=0;n<256;n++){this.p[n]=n;this.g1[n]=(Math.random()*512-256)/256}for(;--n;){g=this.p[n];d=Math.floor(Math.random()*256);this.p[n]=this.p[d];this.p[d]=g}for(n=0;n<258;n++){this.p[256+n]=this.p[n];this.g1[256+n]=this.g1[n]}}});
Laro.register(".geometry.util",function(o){var n=Array.prototype.slice,d=o.toType;this.min=Math.min;this.max=Math.max;this.clamp=function(g){var e=d(g)=="array"?g:n.call(arguments,0),a=Math.min(e[0],Math.min(e[1],e[2]));if(e.length===3){for(var c=0;c<e.length;c++)if(e[c]===a){e.splice(c,1);break}return Math.min(e[0],e[1])}};this.lerp=function(g,e,a){return g+a*(e-g)};Laro.extend(this)});
Laro.register(".input",function(o){var n={a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,blank:32,backspace:8,esc:27,tab:9,enter:13,"~":192,"-":189,_:189,"+":187,"=":187,"{":219,"[":219,"}":221,"]":221,"|":220,":":186,";":186,'"':222,"<":188,">":190,"?":191,up:38,down:40,left:37,right:39,shiftKey:16,ctrlKey:17,altKey:18},d=o.Class(function(g){this.target=
g||window||window.document;this.keyHash=n;this.keyStatus={};this.keyStack=[];this.keydownCallbacks={};this.keyupCallbacks={};this._upKey=this._downKey=null;this._lastKeyupTime=+new Date;this.checkTime=200;this.maxStackLength=10;this.bind()}).methods({bind:function(){var g=this;this.target.addEventListener("keydown",function(e){if(e.keyCode==32||e.keyCode==37||e.keyCode==38||e.keyCode==39||e.keyCode==40)if(e.preventDefault)e.preventDefault();else e.returnValue=false;if(!e.$keyName)e.$keyName=g.getKeyName(e.keyCode);
g.keydown(e);for(var a in g.keydownCallbacks){var c=g.keydownCallbacks[a];typeof c=="function"&&c(e)}},false);this.target.addEventListener("keyup",function(e){if(e.keyCode==32||e.keyCode==37||e.keyCode==38||e.keyCode==39||e.keyCode==40)if(e.preventDefault)e.preventDefault();else e.returnValue=false;g.keyup(e);for(var a in g.keyupCallbacks){var c=g.keyupCallbacks[a];typeof c=="function "&&c(e)}},false)},addKeydownCallback:function(g,e){this.keydownCallbacks[g]=e},addKeyupCallback:function(g,e){this.keyupCallbacks[g]=
e},removeKeydownCallback:function(g){delete this.keydownCallbacks[g]},removeKeyupCallback:function(g){delete this.keyupCallbacks[g]},getKeyName:function(g){for(var e in n)if(n[e]==g)return e;return g},keydown:function(g){if(this.keyStack.length==0||+new Date-this._lastKeyupTime>this.checkTime)this.resetKeyStack();g=this.getKeyName(g.keyCode);!this.key(g)&&this.pushToStack(g);this.keyStatus[g]=true;this._downKey=g},keyup:function(g){g=this.getKeyName(g.keyCode);this.keyStatus[g]=false;this._upKey=
g},key:function(g){return!!this.keyStatus[g]},pushToStack:function(g){var e=+new Date;if(e-this._lastKeyupTime>this.checkTime)this.resetKeyStack(e);else{this._lastKeyupTime=e;this.keyStack.push(g);g=this.keyStack.length;e=this.keyStack;if(g>this.maxStackLength)this.keyStack=e.splice(g-this.maxStackLength)}},resetKeyStack:function(g){this.keyStack=[];this._lastKeyupTime=g||+new Date}}).statics({});this.Keyboard=d;o.extend({Keyboard:d})});
(function(){var o=/andriod|iphone|ipad/.test(navigator.userAgent.toLowerCase()),n=false,d=/horizon/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(b){function f(){!n&&this.init&&this.init.apply(this,arguments)}var k=this.prototype;n=true;var r=new this;n=false;for(var p in b)r[p]=typeof b[p]==="function"&&typeof k[p]==="function"&&d.test(b[p])?function(t,q){return function(){var s=this._super;this._super=k[t];var u=q.apply(this,arguments);this._super=s;return u}}(p,
b[p]):b[p];f.prototype=r;f.constructor=f;f.extend=arguments.callee;return f};var g=function(b,f,k){if(k===undefined)k=true;for(var r in f)if(!b.hasOwnProperty(r)||k)b[r]=f[r];return b},e=Class.extend({init:function(b){this.height=this.width=this.y=this.x=0;this.stage=null;this.draw=function(){};typeof b=="function"?b.call(this):g(this,b||{})}}).extend({init:function(b){this._super(b);this.eventListener={}},addEventListener:function(b,f){if(this.eventListener[b]===null||this.eventListener[b]===undefined)this.eventListener[b]=
[];this.eventListener[b].push(f)},removeEventListener:function(b,f){if(!(this.eventListener[b]===null||this.eventListener[b]===undefined)){for(var k=0;k<this.eventListener[b].length;k++)if(this.eventListener[b][k]==f){delete this.eventListener[b][k];this.eventListener[b].splice(k,1)}this.eventListener[b].length===0&&delete this.eventListener[b]}},removeAllEventListener:function(b){if(!(this.eventListener[b]===null||this.eventListener[b]===undefined)){this.eventListener[b].splice();delete this.eventListener[b]}},
hasEventListener:function(b){return!!this.eventListener[b]&&this.eventListener[b].length>0}}).extend({init:function(b,f){this._super(f);this.ctx=b;this.children=[];this.maxHeight=this.maxWidth=0;this.hoverChildren=[]},addEventListener:function(b,f){this._super(b,f)},removeEventListener:function(b,f){this._super(b,f)},removeAllEventListener:function(b){this._super(b)},hasEventListener:function(b){this._super(b)},getContext:function(){return this.ctx},addChild:function(b){if(this.maxWidth<b.x+b.width)this.maxWidth=
b.x+b.width;if(this.maxHeight<b.y+b.height)this.maxHegiht=b.y+b.height;b.stage=this;this.children.push(b)},addChildAt:function(b,f){if(this.maxWidth<b.x+b.width)this.maxWidth=b.x+b.width;if(this.maxHeight<b.y+b.height)this.maxHeight=b.y+b.height;b.stage=this;this.children.splice(f,0,b)},removeChild:function(b){this.children.splice(this.getChildIndex(b),1);if(this.maxWidth==b.x+b.width)for(var f=this.maxWidth=0;f<this.children.length;f++)if(this.maxWidth<this.children[f].x+this.children[f].width)this.maxWidth=
this.children[f].x+this.children[f].width;if(this.maxHeight==b.y+b.height)for(f=this.maxHeight=0;f<this.children.length;f++)if(this.maxHeight<this.children[f].y+this.children[f].height)this.maxHeight=this.children[f].y+this.children[f].height;b.stage=null},removeChildAt:function(b){this.children[b].stage=null;b=this.children.splice(b,1);if(this.maxWidth==b.x+b.width)for(var f=this.maxWidth=0;f<this.children.length;f++)if(this.maxWidth<this.children[f].x+this.children[f].width)this.maxWidth=this.children[f].x+
this.children[f].width;if(this.maxHeight==b.y+b.height)for(f=this.maxHeight=0;f<this.children.length;f++){this.maxHeight=0;if(this.maxHeight<this.children[f].y+this.children[f].height)this.maxHeight=this.children[f].y+this.children[f].height}},getChildAt:function(b){return this.children[b]},getChildIndex:function(b){for(var f=0;f<this.children.length;f++)if(this.children[f]==b)return f;return-1},contains:function(b){return this.getChildIndex(b)!=-1},dispatchMouseEvent:function(b,f,k){function r(v){var w=
false;if(!v.checkType)v.checkType="rect";switch(v.checkType){case "rect":w=p>v.x&&p<v.x+v.width&&t>v.y&&t<v.y+v.height;break;case "circle":if(typeof v.radius!="number")throw"no radius or radius is not a number";w=Math.sqrt(Math.pow(p-v.x,2)+Math.pow(t-v.y,2))<v.radius}return w}var p=f,t=k;f=[];for(k=0;k<this.children.length;k++){var q=this.children[k];q.dispatchMouseEvent&&q.dispatchMouseEvent(b,p-q.x,t-q.y);if(r(q)){b=="mousemove"&&f.push(q);if(!(q.eventListener[b]==null||q.eventListener[b]==undefined))for(var s=
0,u=q.eventListener[b];s<u.length;s++)u[s](p-q.x,t-q.y)}}if(b=="mousemove"){for(b=0;b<this.hoverChildren.length;b++){k=false;for(q=0;q<f.length;q++)if(this.hoverChildren[b]==f[q])k=true;if(!k){if(this.hoverChildren[b].eventListener.mouseout){k=0;for(q=this.hoverChildren[b];k<q.eventListener.mouseout.length;k++)q.eventListener.mouseout[k](p-q.x,t-q.y)}delete this.hoverChildren[b]}}for(b=0;b<f.length;b++){k=false;for(q=0;q<this.hoverChildren.length;q++)if(f[b]==this.hoverChildren[q])k=true;if(!k){this.hoverChildren.push(f[b]);
if(f[b].eventListener.mouseover){k=0;for(q=f[b];k<q.eventListener.mouseover.length;k++)q.eventListener.mouseover[k](p-q.x,t-q.y)}}}this.clearHoverChildren()}},clearHoverChildren:function(){for(var b=[],f=0;f<this.hoverChildren.length;f++)this.hoverChildren[f]!=null&&this.hoverChildren[f]!=undefined&&b.push(this.hoverChildren[f]);this.hoverChildren=b}}),a=e.extend({init:function(b,f){this._super(b.getContext("2d"),f);if(b===undefined)throw Error("htmlCanvasElement undefined");this.canvas=b;this.isStart=
false;this.interval=16;this.stage=this.timer=null;this.CONFIG={interval:16,isClear:true};this.width=b.width;this.height=b.height;var k=window,r=document.documentElement,p=this;(function(t,q){for(var s=0;s<q.length;s++)t.addEventListener(q[s],function(u,v){return function(w){var x,y=void 0;y=y||p.canvas;x=y.offsetWidth;for(var z=y.offsetHeight,A=y.offsetTop,B=y.offsetLeft;y=y.offsetParent;){A+=y.offsetTop;B+=y.offsetLeft}x={top:A,left:B,width:x,height:z};z={x:k.pageXOffset||r.scrollLeft,y:k.pageYOffset||
r.scrollTop};if(o){w.preventDefault();w=q[v]=="touchend"?w.changedTouches[0]:w.touches[0];y=w.pageX-x.left+z.x;w=w.pageY-x.top+z.y}else{y=w.clientX-x.left+z.x;w=w.clientY-x.top+z.y}if(u.eventListener[q[v]])for(x=0;x<u.eventListener[q[v]].length;x++)u.eventListener[q[v]][x](y,w);u.dispatchMouseEvent(q[v],y,w)}}(p,s),false)})(this.canvas,["mousemove","mouseup","mousedown","click","mouseover","mouseout","mouseenter","mouseleave","touchstart","touchmove","touchend"]);(function(t,q){for(var s=0;s<q.length;s++)t.addEventListener(q[s],
function(u,v){return function(w){if(u.eventListener[q[v]])for(var x=0;x<u.eventListener[q[v]].length;x++)u.eventListener[q[v]][x](w)}}(p,s),false)})(this.canvas,["keyup","keydown","keypress"])},onRefresh:function(){},addEventListener:function(b,f){return this._super(b,f)},removeEventListener:function(b,f){return this._super(b,f)},removeAllEventListener:function(b){return this._super(b)},hasEventListener:function(b){return this._super(b)},getContext:function(){return this._super()},addChild:function(b){return this._super(b)},
addChildAt:function(b,f){return this._super(b,f)},removeChild:function(b){return this._super(b)},removeChildAt:function(b,f){return this._super(b,f)},getChildAt:function(b){return this._super(b)},getChildIndex:function(b){return this._super(b)},contains:function(b){return this._super(b)},dispatchMouseEvent:function(b,f,k){return this._super(b,f,k)},clearHoverChildren:function(){return this._super()},render:function(b){this.CONFIG.isClear&&this.clear();this.draw(b);for(var f=0;f<this.children.length;f++){this.ctx.translate(this.children[f].x,
this.children[f].y);this.children[f].render(b);this.ctx.translate(-this.children[f].x,-this.children[f].y)}},clear:function(b,f,k,r){b!==undefined&&f!==undefined&&k!==undefined&&r!==undefined?this.ctx.clearRect(b,f,k,r):this.ctx.clearRect(0,0,this.width,this.height)},start:function(){this.isStart=true;this.timer=setInterval(function(b){return function(){b.render();b.onRefresh()}}(this),this.CONFIG.interval)},stop:function(){this.isStart=false;clearInterval(this.timer)}}),c=e.extend({init:function(b,
f){this._super(b,f);this.isDragging=false;this.dragPos={};this.dropFunc=this.dragFunc=null},addEventListener:function(b,f){return this._super(b,f)},removeEventListener:function(b,f){return this._super(b,f)},removeAllEventListener:function(b){return this._super(b)},hasEventListener:function(b){return this._super(b)},getContext:function(){return this._super()},addChild:function(b){return this._super(b)},addChildAt:function(b,f){return this._super(b,f)},removeChild:function(b){return this._super(b)},
removeChildAt:function(b){return this._super(b)},getChildAt:function(b){return this._super(b)},getChildIndex:function(b){return this._super(b)},contains:function(b){return this._super(b)},dispatchMouseEvent:function(b,f,k){return this._super(b,f,k)},clearHoverChildren:function(){return this._super()},render:function(b){this.draw(b);this.ctx.scale(this.width<this.maxWidth?this.width/this.maxWidth:1,this.height<this.maxHeight?this.height/this.maxHeight:1);for(var f=0;f<this.children.length;f++){this.ctx.translate(this.children[f].x,
this.children[f].y);this.children[f].render(b);this.children[f].translate(-this.children[f].x,this.children[f].y)}this.ctx.scale(this.width<this.maxWidth?this.maxWidth/this.width:1,this.height<this.maxHeight?this.maxHeight/this.height:1)},onDrag:function(b,f){var k=this;this.isDragging=true;this.dragPos.x=b+this.x;this.dragPos.y=f+this.y;this.dragFunc=function(r,p){var t=p-k.dragPos.y;k.x+=r-k.dragPos.x;k.y+=t;k.dragPos.x=r;k.dragPos.y=p};this.dropFunc=function(){k.onDrop()};this.stage.addEventListener("mousemove",
this.dragFunc);this.stage.addEventListener("mouseout",this.dropFunc)},onDrop:function(){this.isDragging=false;this.dragPos={};this.stage.removeEventListener("mousemove",this.dragFunc);this.stage.removeEventListener("mouseout",this.dropFunc);delete this.dragFunc;delete this.dropFunc}}),j=Class.extend({init:function(b,f){this.x=b;this.y=f},copy:function(){return new j(this.x,this.y)},length:function(){return Math.sqrt(this.sqrLength())},sqrLength:function(){return this.x*this.x+this.y*this.y},normalize:function(){var b=
1/this.length();return new j(this.x*b,this.y*b)},negate:function(){return new j(-this.x,-this.y)},add:function(b){return new j(this.x+b.x,this.y+b.y)},subtract:function(b){return new j(this.x-b.x,this.y-b.y)},multiply:function(b){return new j(this.x*b,this.y*b)},divide:function(b){return new j(this.x/b,this.y/b)},dot:function(b){return new j(this.x*b.x,this.y*b.y)}});j.zero=new j(0,0);var h=Class.extend({init:function(b,f,k){this.r=b;this.g=f;this.b=k},copy:function(){return new h(this.r,this.g,this.b)},
add:function(b){return new h(Math.min(this.r+b.r,1),Math.min(this.g+b.g,1),Math.min(this.b+b.b,1))},subtract:function(b){return new h(Math.max(this.r-b.r,0),Math.max(this.g-b.g,0),Math.max(this.b-b.b,0))},multiply:function(b){return new h(Math.min(this.r*b,1),Math.min(this.g*b,1),Math.min(this.b*b,1))},divide:function(b){return new h(this.r/b,this.g/b,this.b/b)},modulate:function(b){return new h(this.r*b.r,this.g*b.g,this.b*b.b)},saturate:function(){this.r=Math.min(this.r,1);this.g=Math.min(this.g,
1);this.b=Math.min(this.b,1)}});h.black=new h(0,0,0);h.white=new h(1,1,1);h.red=new h(1,0,0);h.green=new h(0,1,0);h.blue=new h(0,0,1);h.yellow=new h(1,1,0);h.cyan=new h(0,1,1);h.purple=new h(1,0,1);e=Class.extend({init:function(b){this.position=b.position;this.velocity=b.velocity;this.acceleration=j.zero;this.age=0;this.life=b.life;this.color=b.color;this.size=b.size}});var i=Class.extend({init:function(){this.$private={particles:[]};this.gravity=new j(0,100);this.effectors=[]},emit:function(b){this.$private.particles.push(b)},
simulate:function(b){this.aging(b);this.applyGravity();this.applyEffectors();this.kinematics(b)},aging:function(b){for(var f=0;f<this.$private.particles.length;){var k=this.$private.particles[f];k.age+=b;if(k.age>k.life)this.kill(f);else f++}},kill:function(b){b<this.$private.particles.length&&this.$private.particles.splice(b,1)},applyGravity:function(){for(var b in this.$private.particles)this.$private.particles[b].acceleration=this.gravity},applyEffectors:function(){for(var b in this.effectors){var f=
this.effectors[b].apply,k;for(k in this.$private.particles)f(this.$private.particles[k])}},kinematics:function(b){for(var f in this.$private.particles){var k=this.$private.particles[f];k.position=k.position.add(k.velocity.multiply(b));k.velocity=k.velocity.add(k.acceleration.multiply(b))}},render:function(b){for(var f in this.$private.particles){var k=this.$private.particles[f];b.fillStyle="rgba("+Math.floor(k.color.r*255)+", "+Math.floor(k.color.g*255)+", "+Math.floor(k.color.b)+", "+(1-k.age/k.life).toFixed(2)+
")";b.beginPath();b.arc(k.position.x,k.position.y,k.size,0,Math.PI*2,true);b.closePath();b.fill()}}}),l=Class.extend({init:function(b,f,k,r){this.apply=function(p){if(p.position.x-p.size<b||p.position.x+p.size>k)p.velocity.x*=-1;if(p.position.y-p.size<f||p.position.y+p.size>r)p.velocity.y*=-1}}}),m={};m.$class=Class;m.$stage=a;m.$sprite=c;m.$vector2=j;m.$color=h;m.$particle=e;m.$particleSystem=i;m.$particleBlock=l;g(m,{createSprite:function(b,f){return new c(b,f)},createPoint3D:function(b,f){var k=
0,r=0,p=0,t=0,q=0,s={x:0,y:0,xpos:0,ypos:0,zpos:0,focalLength:250,width:0,height:0,draw:function(){},setVanishPoint:function(u,v){k=u;r=v},setCenterPoint:function(u,v,w){p=u;t=v;q=w},rotateX:function(u){var v=Math.cos(u);u=Math.sin(u);var w=this.zpos*v+this.ypos*u;this.ypos=this.ypos*v-this.zpos*u;this.zpos=w},rotateY:function(u){var v=Math.cos(u);u=Math.sin(u);var w=this.zpos*v+this.xpos*u;this.xpos=this.xpos*v-this.zpos*u;this.zpos=w},rotateZ:function(u){var v=Math.cos(u);u=Math.sin(u);var w=this.ypos*
v+this.xpos*u;this.xpos=this.xpos*v-this.ypos*u;this.ypos=w},getScale:function(){return this.focalLength/(this.focalLength+this.zpos+q)},getScreenXY:function(){var u=this.getScale();return{x:k+(p+this.xpos)*u,y:r+(t+this.ypos)*u}}};typeof f=="function"?f.call(s):g(s,f||{});s=new c(b,s);Object.defineProperties(s,{screenX:{get:function(){return this.getScreenXY().x}},screenY:{get:function(){return this.getScreenXY().y}}});return s},createTriangle:function(b,f,k,r,p,t){t=t==undefined?true:t;b=m.createSprite(b,
function(){this.color=p;this.light=null;this.draw=function(q){if(!((r.screenX-f.screenX)*(k.screenY-r.screenY)>(r.screenY-f.screenY)*(k.screenX-r.screenX))){q=q||this.ctx;q.beginPath();q.moveTo(f.screenX,f.screenY);q.lineTo(k.screenX,k.screenY);q.lineTo(r.screenX,r.screenY);q.lineTo(f.screenX,f.screenY);q.closePath();var s;if(this.light){s=this.color>>16;var u=this.color>>8&255,v=this.color&255,w;w={x:f.xpos-k.xpos,y:f.ypos-k.ypos,z:f.zpos-k.zpos};var x={x:k.xpos-r.xpos,y:k.ypos-r.ypos,z:k.zpos-r.zpos};
w={x:w.y*x.z-w.z*x.y,y:-(w.x*x.z-w.z*x.x),z:w.x*x.y-w.y*x.x};w=Math.acos((w.x*this.light.x+w.y*this.light.y+w.z*this.light.z)/(Math.sqrt(w.x*w.x+w.y*w.y+w.z*w.z)*Math.sqrt(this.light.x*this.light.x+this.light.y*this.light.y+this.light.z*this.light.z)))/Math.PI*this.light.brightness;s*=w;u*=w;v*=w;s=s<<16|u<<8|v}else s=this.color;s=s;if(typeof s=="number")s="rgb("+(s>>16)+", "+(s>>8&255)+", "+(s&255)+")";q.fillStyle=s;q.fill();if(!t){q.strokeStyle=s;q.stroke()}}}});Object.defineProperties(b,{depth:{get:function(){return Math.min(f.z,
k.z,r.z)}}});return b},createLight:function(b,f,k,r){b=b===undefined?-100:b;f=f===undefined?-100:f;k=k===undefined?-100:k;r=r===undefined?1:r;return Object.defineProperties({x:b,y:f,z:k},{brightness:{get:function(){return r},set:function(p){r=Math.min(Math.max(p,0),1)}}})}});if(this.Laro&&Laro.extend)Laro.extend(m);else this.CVS=m})();
